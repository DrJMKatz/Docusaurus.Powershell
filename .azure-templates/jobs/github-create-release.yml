# -----------------------------------------------------------------------------
# Job that creates a Github release by creating a Git tag with markdown body.
#
# - requires protected Azure Pipeline environment variable `GITHUB_API_KEY`
# - will not create the release if [no-release] is in the commit message
# -----------------------------------------------------------------------------
parameters:
  dependsOn: []
  artifactName: ''
  artifactDownloadDirectory: $(Build.ArtifactStagingDirectory)

jobs:
  - job: Github
    dependsOn: ${{ parameters.dependsOn }}
    workspace:
      clean: outputs

    pool:
      vmImage: 'windows-2019'

    steps:
    - template: ../steps/log-virtual-machine-information.yml
    - template: ../steps/set-skip-release-variable.yml

    # log template parameters
    - powershell: |
        Write-Host "jobName                  = ${{ parameters.jobName }}"
        Write-Host "artifactName              = ${{ parameters.artifactName }}"
        Write-Host "artifactDownloadDirectory = ${{ parameters.artifactDownloadDirectory }}"
      displayName: 'Template Parameters'
      condition: not(contains(variables['Build.SourceVersionMessage'], '[no-release]'))

    # download the module artifact
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Build Artifacts'
      condition: ne(variables['SKIP_RELEASE'], 'True')
      inputs:
        artifactName: ${{ parameters.artifactName }}
        downloadPath: ${{ parameters.artifactDownloadDirectory }}

    # todo: directly commit the .psd1


    # create the Github Release using the Github API
    - powershell: |
        if(-Not($env:MAPPED_GITHUB_API_KEY)) {
          throw "Azure pipeline protected variable GITHUB_API_KEY does not exist. Are you sure you configured it using the Azure Devops web interface?"
        }

        # being lazy for now, single module only
        $moduleName = Get-ChildItem -Path "${{ parameters.artifactDownloadDirectory }}" -Directory
        $moduleVersion = Get-ChildItem -Path (Join-Path -Path "${{ parameters.artifactDownloadDirectory }}" -ChildPath $moduleName) -Directory
        $moduleFolder = [IO.Path]::Combine("${{ parameters.artifactDownloadDirectory }}", $moduleName, $moduleVersion)
        Write-Host "moduleName    = $moduleName"
        Write-Host "moduleVersion = $moduleVersion"
        Write-Host "moduleFolder = $moduleFolder"
        Get-ChildItem -Path $moduleFolder

        $jsonBody = @{
          tag_name = "$moduleVersion"
          target_commitish = "master"
          name = "Release $moduleVersion"
          body = "This must become markdown"
          draft = $False
          prerelease = $False
        } | ConvertTo-Json

        Write-Host $jsonBody

      displayName: 'Create Release'
      condition: not(contains(variables['Build.SourceVersionMessage'], '[no-release]'))
      env:
        MAPPED_GITHUB_API_KEY: $(GITHUB_API_KEY)
